---
title: JS高程 第十三章 事件
date: 2017-11-04 00:11:22
tags: [读书笔记, JavaScript高级程序设计]
---

> 事件是JavaScript和HTML文档交互的核心，事件就是文档或浏览器窗口中发生一些特定交互的瞬间。可以通过监听器或处理程序来预定事件。这种方式在传统软件工程中称为观察者模式，以支持页面的行为与页面外观之间的松散耦合。

<!--more-->

## 事件流

事件流描述的是从页面接受事件的顺序。有意思的地方是IE和Netscape开发团队提出了差不多完全相反的事件流概念。IE的事件流是事件冒泡流，而Netscape的事件流是事件捕获流。

### 事件冒泡流

IE的事件流叫做事件冒泡流，即事件开始由具体的元素接受，然后逐级向上传播到较为不具体的节点。以HTML代码为例：

```
<!DOCTYPE html>
<html>
<head>
    <title>Event Bubbling Example</title>
</head>
<body>
    <div id="myDiv">Click Me</div>
</body>
</html>
```

如果你单击了页面中的&lt;div&gt;元素，那么这个click事件将会按照如下顺序传播：

1. &lt;div&gt;
2. &lt;body&gt;
3. &lt;html&gt;
4. document

也就是说事件首先在&lt;div&gt;元素发生，然后沿着DOM树向上传播，直到document对象：

![](https://codefinger.cn/wp-content/uploads/2017/11/Screen-Shot-2017-11-04-at-00.23.35.png)

### 事件捕获

还是上面的那段代码，事件捕获的传播顺序如下：

1. document
2. &lt;html&gt;
3. &lt;body&gt;
4. &lt;div&gt;

也就说事件捕获中，document首先接收到click事件，然后事件沿着DOM树向下传播：

![](https://codefinger.cn/wp-content/uploads/2017/11/Screen-Shot-2017-11-04-at-00.26.17.png)

### DOM事件流

DOM2级事件规定的事件流分为三个阶段：事件捕获阶段、处于目标阶段、事件冒泡阶段。

![](https://codefinger.cn/wp-content/uploads/2017/11/Screen-Shot-2017-11-04-at-00.28.19.png)

> IE9、Opera、Firefox、Chrome和Safari都支持DOM事件流；IE8及更早版本不支持DOM事件流。

## 事件处理程序

事件就是用户和浏览器自身执行的某种动作。诸如click、load和mouseover，都是事件的名字。而响应某个事件的函数就叫做事件处理程序。事件处理程序的名字以"on"开头，因此事件处理程序就是onclick, onload, onmouseover。

### HTML事件处理程序

在HTML中直接指定事件处理程序，实际上是采用with语句进行扩展作用域，能够像使用本地变量的方式使用绑定的元素。这种方式很方便，但是存在很多缺点：

- 事件绑定的函数在触发时可能没有加载，这将导致事件触发没有响应。
- 事件采用的扩展作用域的方式在不同浏览器的支持不同，可能导致问题。
- HTML代码与JavaScript逻辑紧耦合，修改压力比较大。

### DOM0级事件处理程序

通过JavaScript指定事件处理程序的传统方式，就是将一个函数赋值给一个事件处理程序属性。这种方式为元素绑定事件，至今仍为现代浏览器支持，原因一是简单，二是具有跨浏览器的优势。删除事件可以直接将事件处理程序属性置空。

### DOM2级事件处理程序

DOM2级事件处理程序定义了两个方法，用于指定和删除事件处理程序：

- addEventListener
- removeEventListener

这两个方法都接受3个参数：要处理的事件名，作为事件处理的函数和一个表示是否在事件捕获阶段处理程序。

同一个元素绑定了多个事件，将按照代码的顺序执行。

如果绑定的事件处理函数是匿名函数，那么不能通过remove方法移除，因此必须都过函数引用来进行添加和删除。

### IE事件处理程序

IE实现了与DOM中类似的两个方法：

- attachEvent
- detachEvent

这两个方法接收相同的两个参数：事件处理程序名称和事件处理函数。因为IE8及之前的版本只支持时间冒泡，因此通过方法添加的事件处理程序都只能发生在冒泡阶段。

与DOM2级的事件方法类似，同样也不能移除匿名函数。

### 跨浏览器事件处理程序

为了处理跨浏览器事件，因此需要充分的能力检测，然后针对不同的浏览器进行不同的事件注册。

## 事件对象

在触发DOM上的某个事件时，会产生一个事件对象event。这个对象包含所有与事件相关的信息，包括导致事件的元素，事件的类型，以及其他与事件相关的信息。event对象只在事件发生时创建，在事件结束时就会被销毁。

## 事件类型

Web浏览器中可能发生的事件类型有很多。如前所述，不同的事件类型具有不同的信息，而DOM3级事件规定了以下几类事件：

- UI事件： 当用户与页面上的元素交互触发；
- 焦点事件： 当元素获得或失去焦点时触发；
- 鼠标事件： 当用户通过鼠标在页面上执行操作时触发；
- 滚轮事件： 当使用鼠标滚轮或类似设备时触发；
- 文本事件： 当在文档中输入文本时触发；
- 键盘事件： 当用户通过键盘在页面上执行时触发；
- 变动事件： 当底层DOM结构发生变化时触发；
- 变动名称事件： 当元素或属性名变动时触发。

除了这些事件外，HTML5也定义了一组事件，而有些浏览器还会在DOM和BOM中实现其他专有事件。

## 内存和性能

由于事件处理程序可以为现代Web应用程序提供交互能力，因此会导致滥用。因为每个事件处理程序都会占用内存，因此会导致整体性能下降。

### 事件委托

事件委托主要是解决事件处理程序过多的问题，通过直接在父元素绑定事件处理程序，而不是为每一个子元素绑定事件的方式，可以大幅度减少事件处理程序的创建，这种方式是基于事件冒泡流来进行创造的。

### 移除事件处理程序

因为在页面销毁时，如两个页面或页面刷新行为时，一些不再使用的事件处理程序，应当被移除，而不是在页面中占据内存。

## 模拟事件

所谓模拟事件，实际上就是通过改造event对象来实现的，同时也能让开发者自定义事件的触发，比如可以让一个键盘事件触发鼠标事件等等，使用起来很简单，也很有趣。

## 小结

本章内容实际上很多，主要是对各个事件进行了详细的使用教程，这部分内容如果不使用没什么意义，主要需要关注事件作为JavaScript和网页的交互以及事件流。在使用事件的需要重点考虑内存和性能的问题：

- 有必要限制一个页面中事件处理程序的数量，数量太多会导致占用大量的内存，而且会让用户感觉页面反应不够灵敏。
- 建立在事件冒泡机制之上的事件委托技术，可以有效的减少事件处理程序的数量。
- 建议浏览器卸载页面之前移除页面中所有的事件处理程序。

事件是JavaScript中最重要的主题之一，深入理解事件的工作机制以及它们对性能的影响至关重要。